label: Scenario succeeds

when:
  - describe: ".app.base_url"
    should:
      contain_string: "localhost"

default:
  request:
    path: /json
  response:
    status_code: 200
    headers:
      - describe: ."content-type"
        should:
          equal: application/json

cases:
  - label: Sends headers and validates headers
    request:
      path: /header
      headers:
        header-string: xxx
        Header-String: yyy
        user-agent: custom
    response:
      headers:
        - describe: ."content-type"
          should:
            equal: application/json
        - describe:
            jq: ."content-length"
            cast_to: int
          should:
            be_greater_than: 100
      body:
        - describe: ."header-string"
          should:
            equal: yyy
        - describe: ."user-agent"
          should:
            equal: custom

  - label: Sends params
    request:
      path: /params
      params:
        key: value
        multi-key:
          - value1
          - value2
    response:
      body:
        - describe: .key
          should:
            equal: value
        - describe: ."multi-key"
          should:
            equal: value2

  - label: Validates status codes
    request:
      path: /error/404
    response:
      status_code:
        - equal: 404
        - be_greater_than: 399
        - be_greater_than_or_equal_to: 400
        - be_less_than_or_equal_to: 499
        - be_less_than: 500

  - label: Matches objects
    response:
      body:
        - describe: .not_existing_key
          should: be_null
        - describe: .empty_string
          should: be_empty
        - describe: .empty_list
          should: be_empty
        - describe: .foo
          should:
            - not_be_null
            - equal: bar
            - have_length: 3

  - label: Matches comparable objects
    response:
      body:
        - describe: .foo
          should:
            - all_of:
              - be_greater_than: baqz
              - be_less_than: bb

  - label: Matches strings
    response:
      body:
        - describe: .foo
          should:
            - contain_string: a
            - start_with: ba
            - end_with: ar
            - match_regexp: ^b.r$

  - label: Matches datetime
    request: /later/1
    response:
      status_code: 200
      body:
        - describe: .now
          should:
            - be_before: 1 minute
            - be_after: -2 minutes
            - be_after: 1 second  # Must be processed after 1 seconds.

  - label: Matches sequences
    response:
      body:
        - describe: .list
          should:
            - not:
                have_item: ''
            - have_item: 1
        - describe:
            jq: .items[].x
            multiple: true
          should:
            equal: ['1', null, '2']
        - describe:
            jq: .items[].x
            multiple: true
            cast_to: int
          should:
            - contain: [1, null, 2]
            - contain_in_any_order: [1, 2, be_null]
            - have_items: [1, 2]

  - label: Matches logically
    response:
      body:
        - describe: .foo
          should:
            - anything
            - not: be_empty
            - be: bar
            - be:
                not: baz
            - be:
                not:
                  contain_string: x
        - describe:
            jq: .items[].x
            multiple: true
            cast_to: int
          should:
            - all_of:
                - have_item: 1
                - have_item: 2
            - any_of:
                - have_item: 100
                - have_item: be_null

  - label: Analyzes XML
    request: /xml
    response:
      headers:
        - describe: ."content-type"
          should:
            equal: "application/xml"
      body:
        analyze_as: xml
        descriptions:
          - describe:
              xpath: /root/foo
            should:
              equal: '1'
          - describe:
              xpath: /root/foo
              cast_to: int
            should:
              equal: 1
          - describe:
              xpath: /root/foo
              multiple: true
              cast_to: float
            should:
              equal: [1.0, 2.0]
          - describe:
              xpath: ./foo[1]/@id
            should:
              equal: foo1
          - describe:
              xpath: //baz/@id
            should:
              equal: baz1

  - label: No description doesn't fail
    response:
      body:
        describe: .foo

  - label: No validations for plain texts doesn't fail
    request:
      path: /text
    response:
      headers:
        describe: ."content-type"
        should:
          equal: text/plain

  - label: No analysis for binary data doesn't fail
    request: /binary
    response:
      headers:
        describe:
          jq: ."content-length"
          cast_to: int
        should:
          be_greater_than: 0

  - label: Disabled
    enabled: false
    request: /invalid
    response:
      status_code: 200

subscenarios:
  - !include ./example-skipped.yml
  - label: Subscenario succeeds
    default:
      path: /error/404
    cases:
      - label: Default value is inherited and can be overwritten
        response:
          status_code: 404
          headers:
            describe: ."content-type"
            should:
              start_with: 'text/plain'
